var C=Object.defineProperty;var H=(s,e,t)=>e in s?C(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>H(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();function y(s){return JSON.stringify(s)}class V{constructor(e){a(this,"ws",null);a(this,"sessionId");a(this,"reconnectAttempts",0);a(this,"maxReconnectAttempts",5);a(this,"reconnectDelay",1e3);a(this,"messageHandlers",[]);a(this,"errorHandlers",[]);a(this,"connectHandlers",[]);a(this,"disconnectHandlers",[]);a(this,"pendingRequests",new Map);a(this,"requestId",0);a(this,"createCallbackQueue",[]);this.sessionId=e}connect(){return new Promise((e,t)=>{const n=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/${this.sessionId}`;this.ws=new WebSocket(n),this.ws.onopen=()=>{this.reconnectAttempts=0,this.connectHandlers.forEach(o=>o()),e()},this.ws.onmessage=o=>{try{const r=JSON.parse(o.data);"result"in r||"error"in r&&!("type"in r)||"pending"in r?this.handleResponse(r):this.handleMessage(r)}catch(r){console.error("Failed to parse message:",r)}},this.ws.onerror=o=>{console.error("WebSocket error:",o),t(new Error("WebSocket connection failed"))},this.ws.onclose=()=>{this.disconnectHandlers.forEach(o=>o()),this.attemptReconnect()}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.errorHandlers.forEach(t=>t("Max reconnection attempts reached"));return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect().catch(()=>{})},e)}handleMessage(e){this.messageHandlers.forEach(t=>t(e))}handleResponse(e){e.pending&&e.pending.forEach(i=>this.handleMessage(i)),e.result&&typeof e.result=="object"&&"id"in e.result&&this.createCallbackQueue.length>0&&this.createCallbackQueue.shift()(e)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(y(e)):console.error("WebSocket not connected")}sendAndAwaitResponse(e){return new Promise((t,i)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){i(new Error("WebSocket not connected"));return}this.createCallbackQueue.push(t),this.ws.send(y(e))})}async sendRequest(e){return new Promise(t=>{const i=this.requestId++;this.pendingRequests.set(i,t),this.send(e)})}onMessage(e){return this.messageHandlers.push(e),()=>{const t=this.messageHandlers.indexOf(e);t>=0&&this.messageHandlers.splice(t,1)}}onError(e){return this.errorHandlers.push(e),()=>{const t=this.errorHandlers.indexOf(e);t>=0&&this.errorHandlers.splice(t,1)}}onConnect(e){return this.connectHandlers.push(e),()=>{const t=this.connectHandlers.indexOf(e);t>=0&&this.connectHandlers.splice(t,1)}}onDisconnect(e){return this.disconnectHandlers.push(e),()=>{const t=this.disconnectHandlers.indexOf(e);t>=0&&this.disconnectHandlers.splice(t,1)}}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}}class M{constructor(e){a(this,"variables",new Map);a(this,"errors",new Map);a(this,"watchers",new Map);a(this,"errorWatchers",new Map);a(this,"connection");this.connection=e,e.onMessage(t=>{if(t.type==="update"){const i=t.data;this.handleUpdate(i.varId,i.value,i.properties)}else if(t.type==="destroy"){const i=t.data;this.handleDestroy(i.varId)}else if(t.type==="error"){const i=t.data;i.varId!==void 0&&this.handleError(i.varId,i.code,i.description)}})}handleUpdate(e,t,i){let n=this.variables.get(e);n||(n={value:void 0,properties:{}},this.variables.set(e,n)),t!==void 0&&(n.value=t),i&&(n.properties={...n.properties,...i}),this.errors.has(e)&&(this.errors.delete(e),this.notifyErrorWatchers(e,null));const o=this.watchers.get(e);o&&o.forEach(r=>r(n.value,n.properties))}handleError(e,t,i){const n={code:t,description:i};this.errors.set(e,n),this.notifyErrorWatchers(e,n)}notifyErrorWatchers(e,t){const i=this.errorWatchers.get(e);i&&i.forEach(n=>n(t))}handleDestroy(e){this.variables.delete(e),this.watchers.delete(e)}watch(e,t){let i=this.watchers.get(e);return i||(i=new Set,this.watchers.set(e,i),this.connection.send({type:"watch",data:{varId:e}})),i.add(t),()=>{i.delete(t),i.size===0&&(this.watchers.delete(e),this.connection.send({type:"unwatch",data:{varId:e}}))}}watchErrors(e,t){let i=this.errorWatchers.get(e);i||(i=new Set,this.errorWatchers.set(e,i)),i.add(t);const n=this.errors.get(e)??null;return t(n),()=>{i.delete(t),i.size===0&&this.errorWatchers.delete(e)}}getError(e){return this.errors.get(e)??null}get(e){return this.variables.get(e)}async create(e){const t=await this.connection.sendAndAwaitResponse({type:"create",data:e});if(t.error)throw new Error(t.error);if(!t.result)throw new Error("No result from create");return t.result.id}update(e,t,i){this.connection.send({type:"update",data:{varId:e,value:t,properties:i}})}destroy(e){this.connection.send({type:"destroy",data:{varId:e}})}sendError(e,t,i){this.connection.send({type:"error",data:{varId:e,code:t,description:i}}),this.handleError(e,t,i)}}function v(s){const[e,t]=s.split("?"),i=e.split("."),n={};if(t){const o=new URLSearchParams(t);o.has("create")&&(n.create=o.get("create")),o.has("wrapper")&&(n.wrapper=o.get("wrapper")),o.has("item")&&(n.item=o.get("item"));const r={};o.forEach((d,c)=>{c!=="create"&&c!=="wrapper"&&c!=="item"&&(r[c]=d)}),Object.keys(r).length>0&&(n.props=r)}return{segments:i,options:n}}function O(s){const e={};return s.create&&(e.create=s.create),s.wrapper&&(e.wrapper=s.wrapper),s.item&&(e.item=s.item),s.props&&Object.assign(e,s.props),e}function b(s,e){let t=s;for(const i of e){if(t==null)return;if(typeof t=="object")Array.isArray(t)&&/^\d+$/.test(i)?t=t[parseInt(i,10)]:t=t[i];else return}return t}class R{constructor(e){a(this,"store");a(this,"bindings",new Map);this.store=e}bindElement(e,t){const i=[],n=e.getAttribute("ui-value");if(n){const r=this.createValueBinding(e,t,n);r&&i.push(r)}for(const r of Array.from(e.attributes))if(r.name.startsWith("ui-attr-")){const d=r.name.substring(8),c=this.createAttrBinding(e,t,r.value,d);c&&i.push(c)}for(const r of Array.from(e.attributes))if(r.name.startsWith("ui-class-")){const d=r.name.substring(9),c=this.createClassBinding(e,t,r.value,d);c&&i.push(c)}for(const r of Array.from(e.attributes))if(r.name.startsWith("ui-style-")){const d=r.name.substring(9),c=this.createStyleBinding(e,t,r.value,d);c&&i.push(c)}for(const r of Array.from(e.attributes))if(r.name.startsWith("ui-event-")){const d=r.name.substring(9),c=this.createEventBinding(e,t,r.value,d);c&&i.push(c)}const o=e.getAttribute("ui-action");if(o){const r=this.createActionBinding(e,t,o);r&&i.push(r)}i.length>0&&this.bindings.set(e,i);for(const r of Array.from(e.children))this.bindElement(r,t)}unbindElement(e){const t=this.bindings.get(e);t&&(t.forEach(i=>i.unbind()),this.bindings.delete(e));for(const i of Array.from(e.children))this.unbindElement(i)}createValueBinding(e,t,i){const n=v(i),o=O(n.options);o.path=n.segments.join(".");let r=null,d=null,c=null;const h=l=>{e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement?e.value=(l==null?void 0:l.toString())??"":e.textContent=(l==null?void 0:l.toString())??""},u=l=>{l?(e.classList.add("ui-error"),e.setAttribute("data-ui-error-code",l.code),e.setAttribute("data-ui-error-description",l.description)):(e.classList.remove("ui-error"),e.removeAttribute("data-ui-error-code"),e.removeAttribute("data-ui-error-description"))},p=l=>{if(r!==null){const g=l.target;this.store.update(r,g.value)}};this.store.create({parentId:t,properties:o}).then(l=>{r=l,d=this.store.watch(l,L=>h(L)),c=this.store.watchErrors(l,u);const g=this.store.get(l);g&&h(g.value)}).catch(l=>{console.error("Failed to create binding variable:",l)}),(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&e.addEventListener("input",p);const E=l=>{const g=l;r!==null&&this.store.update(r,g.detail.value)};return e.addEventListener("ui-value-change",E),{element:e,unbind:()=>{d&&d(),c&&c(),e.removeEventListener("input",p),e.removeEventListener("ui-value-change",E),r!==null&&this.store.destroy(r),e.classList.remove("ui-error"),e.removeAttribute("data-ui-error-code"),e.removeAttribute("data-ui-error-description")}}}createAttrBinding(e,t,i,n){const o=v(i),r=h=>{const u=b(h,o.segments);u!=null&&u!==!1?e.setAttribute(n,u.toString()):e.removeAttribute(n)},d=this.store.watch(t,h=>r(h)),c=this.store.get(t);return c&&r(c.value),{element:e,unbind:d}}createClassBinding(e,t,i,n){const o=v(i),r=h=>{b(h,o.segments)?e.classList.add(n):e.classList.remove(n)},d=this.store.watch(t,h=>r(h)),c=this.store.get(t);return c&&r(c.value),{element:e,unbind:d}}createStyleBinding(e,t,i,n){const o=v(i),r=e,d=u=>{const p=b(u,o.segments);p!=null?r.style.setProperty(n,p.toString()):r.style.removeProperty(n)},c=this.store.watch(t,u=>d(u)),h=this.store.get(t);return h&&d(h.value),{element:e,unbind:c}}createEventBinding(e,t,i,n){const o=r=>{this.executeAction(t,i,r)};return e.addEventListener(n,o),{element:e,unbind:()=>e.removeEventListener(n,o)}}createActionBinding(e,t,i){const n=o=>{o.preventDefault(),this.executeAction(t,i,o)};return e.addEventListener("click",n),{element:e,unbind:()=>e.removeEventListener("click",n)}}executeAction(e,t,i){const n=t.match(/^(\w+)\((.*)\)$/);if(!n){console.error("Invalid action expression:",t);return}const[,o,r]=n,d=r?r.split(",").map(c=>c.trim()):[];this.store.update(e,void 0,{action:o,"action-args":JSON.stringify(d)})}}function k(s){const e=s.indexOf(".");return e===-1?null:{type:s.substring(0,e),namespace:s.substring(e+1)}}function S(s,e){return`${s}.${e}`}function B(s){const e=document.createElement("div");if(e.innerHTML=s.trim(),e.children.length!==1)return null;const t=e.children[0];return t instanceof HTMLTemplateElement?t:null}function x(s,e){const t=k(s);if(!t)return null;const i=B(e);return i?{type:t.type,namespace:t.namespace,template:i}:null}function I(s){return s.template.content.cloneNode(!0)}class T{constructor(){a(this,"viewdefs",new Map);a(this,"pendingViews",new Map);a(this,"errorHandler")}setErrorHandler(e){this.errorHandler=e}store(e,t){const i=x(e,t);return i?(this.viewdefs.set(e,i),!0):(this.errorHandler&&this.errorHandler(e,"Invalid viewdef: must be a single <template> element"),!1)}processViewdefs(e){for(const[t,i]of Object.entries(e))this.store(t,i);this.processPendingViews()}get(e,t){const i=S(e,t),n=this.viewdefs.get(i);if(n)return n;if(t!=="DEFAULT"){const o=S(e,"DEFAULT");return this.viewdefs.get(o)}}getByKey(e){return this.viewdefs.get(e)}has(e,t){return this.get(e,t)!==void 0}addPendingView(e){this.pendingViews.set(e.id,e)}removePendingView(e){this.pendingViews.delete(e)}processPendingViews(){const e=[];for(const[t,i]of this.pendingViews)i.render()&&e.push(t);for(const t of e)this.pendingViews.delete(t)}getPendingViewCount(){return this.pendingViews.size}getViewdefCount(){return this.viewdefs.size}getKeys(){return Array.from(this.viewdefs.keys())}clear(){this.viewdefs.clear()}}function W(s){return typeof s=="object"&&s!==null&&"obj"in s&&typeof s.obj=="number"}let N=1;function j(){return`ui-view-${N++}`}class D{constructor(e,t,i,n){a(this,"element");a(this,"htmlId");a(this,"namespace");a(this,"variableId",null);a(this,"rendered",!1);a(this,"viewdefStore");a(this,"variableStore");a(this,"unwatch",null);a(this,"bindCallback");this.element=e,this.htmlId=e.id||j(),e.id||(e.id=this.htmlId),this.namespace=e.getAttribute("ui-namespace")||"DEFAULT",this.viewdefStore=t,this.variableStore=i,this.bindCallback=n,e.getAttribute("ui-view")}setVariable(e){this.unwatch&&(this.unwatch(),this.unwatch=null),this.variableId=e,this.rendered=!1,this.unwatch=this.variableStore.watch(e,()=>{this.render()}),this.render()}setVariableFromRef(e){W(e)?this.setVariable(e.obj):this.clear()}render(){if(this.variableId===null)return!1;const e=this.variableStore.get(this.variableId);if(!e)return this.markPending(),!1;const t=e.properties.type;if(!t)return this.markPending(),!1;const i=this.viewdefStore.get(t,this.namespace);if(!i)return this.markPending(),!1;this.clear();const n=I(i);if(this.bindCallback)for(const o of n.children)o instanceof HTMLElement&&this.bindCallback(o,this.variableId);return this.element.appendChild(n),this.rendered=!0,this.removePending(),!0}clear(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.rendered=!1}markPending(){this.viewdefStore.addPendingView({id:this.htmlId,render:()=>this.render()})}removePending(){this.viewdefStore.removePendingView(this.htmlId)}isRendered(){return this.rendered}getVariableId(){return this.variableId}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.removePending(),this.clear()}}const U=1;class F{constructor(e,t,i,n){a(this,"element");a(this,"variableId",U);a(this,"namespace");a(this,"view",null);a(this,"viewdefStore");a(this,"variableStore");a(this,"unwatch",null);a(this,"bindCallback");this.element=e,this.namespace=e.getAttribute("ui-namespace")||"DEFAULT",this.viewdefStore=t,this.variableStore=i,this.bindCallback=n}initialize(){this.view=new D(this.element,this.viewdefStore,this.variableStore,this.bindCallback),this.view.setVariable(this.variableId),this.unwatch=this.variableStore.watch(this.variableId,(e,t)=>{this.handleRootUpdate(e,t)})}handleRootUpdate(e,t){console.log("handleRootUpdate called, props:",Object.keys(t));const i=t.viewdefs;if(i){console.log("Found viewdefs property, length:",i.length);try{const n=JSON.parse(i);typeof n=="object"&&n!==null&&(console.log("Parsed viewdefs, keys:",Object.keys(n)),this.viewdefStore.processViewdefs(n))}catch(n){console.error("Failed to parse viewdefs property:",n)}}else console.log("No viewdefs property found")}getView(){return this.view}isRendered(){var e;return((e=this.view)==null?void 0:e.isRendered())??!1}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.view&&(this.view.destroy(),this.view=null)}}function m(){return document.querySelector("[ui-app]")}function q(s,e,t){const i=m();if(!i)return null;const n=new F(i,s,e,t);return n.initialize(),n}class z{constructor(){a(this,"connection");a(this,"store");a(this,"viewdefStore");a(this,"binding");a(this,"sessionId");a(this,"appView",null);this.sessionId=this.extractSessionId(),this.connection=new V(this.sessionId),this.store=new M(this.connection),this.viewdefStore=new T,this.binding=new R(this.store)}extractSessionId(){const t=window.location.pathname.split("/").filter(Boolean);if(t.length>0)return t[0];throw new Error("No session ID in URL")}async initialize(){this.connection.onConnect(()=>{console.log("Connected to session:",this.sessionId)}),this.connection.onDisconnect(()=>{console.log("Disconnected from session")}),this.connection.onError(t=>{console.error("Connection error:",t)}),this.connection.onMessage(t=>{this.handleMessage(t)}),await this.connection.connect(),m()&&(this.appView=q(this.viewdefStore,this.store,(t,i)=>this.binding.bindElement(t,i)))}handleMessage(e){switch(e.type){case"error":const t=e.data;console.error("Server error:",t.description);break}}navigateTo(e){window.history.pushState({},"",e),this.handleNavigation()}handleNavigation(){const i="/"+window.location.pathname.split("/").filter(Boolean).slice(1).join("/");this.store.update(1,void 0,{url:i})}getStore(){return this.store}getViewdefStore(){return this.viewdefStore}getConnection(){return this.connection}getAppView(){return this.appView}}function $(){const s=new z;return s.initialize().then(()=>s)}document.addEventListener("DOMContentLoaded",()=>{m()&&$().catch(console.error)});const J=new Map;function f(s,e){J.set(s.toLowerCase(),e)}function A(s,e,t){const i=s,n=t.get("ui-value");n&&e.value!==void 0&&(i.value=String(e.value));const o=t.get("ui-attr-disabled");o&&(w(e,o)?i.setAttribute("disabled",""):i.removeAttribute("disabled"));const r=t.get("ui-attr-placeholder");if(r){const d=w(e,r);d!==void 0&&i.setAttribute("placeholder",String(d))}s.addEventListener("sl-change",d=>{const c=d.target;s.dispatchEvent(new CustomEvent("ui-value-change",{detail:{value:c.value,path:n},bubbles:!0}))})}function K(s,e,t){A(s,e,t)}function Q(s,e,t){const i=t.get("ui-action");i&&s.addEventListener("click",()=>{s.dispatchEvent(new CustomEvent("ui-action-trigger",{detail:{action:i},bubbles:!0}))});const n=t.get("ui-attr-disabled");n&&(w(e,n)?s.setAttribute("disabled",""):s.removeAttribute("disabled"));const o=t.get("ui-attr-loading");o&&(w(e,o)?s.setAttribute("loading",""):s.removeAttribute("loading"))}function _(s,e,t){const i=s,n=t.get("ui-value");n&&e.value!==void 0&&(i.value=String(e.value)),s.addEventListener("sl-change",o=>{const r=o.target;s.dispatchEvent(new CustomEvent("ui-value-change",{detail:{value:r.value,path:n},bubbles:!0}))})}function P(s,e,t){const i=s,n=t.get("ui-value");n&&e.value!==void 0&&(i.checked=!!e.value),s.addEventListener("sl-change",o=>{const r=o.target;s.dispatchEvent(new CustomEvent("ui-value-change",{detail:{value:r.checked,path:n},bubbles:!0}))})}function G(s,e,t){P(s,e,t)}function X(s,e,t){const i=s,n=t.get("ui-value");n&&e.value!==void 0&&(i.value=String(e.value)),s.addEventListener("sl-change",o=>{const r=o.target;s.dispatchEvent(new CustomEvent("ui-value-change",{detail:{value:r.value,path:n},bubbles:!0}))})}function Y(s,e,t){const i=t.get("ui-attr-value");if(i){const n=w(e,i);n!==void 0&&s.setAttribute("value",String(n))}}function Z(s,e,t){const i=s,n=t.get("ui-attr-open");if(n){const o=w(e,n);i.open=!!o}}function ee(s,e,t){const i=t.get("ui-columns"),n=t.get("ui-value");s.dataset.tabulatorConfig=JSON.stringify({columns:i,data:n}),s.dispatchEvent(new CustomEvent("ui-tabulator-init",{detail:{columns:i,data:e.value},bubbles:!0}))}function w(s,e){if(e){if(typeof s.value=="object"&&s.value!==null){const t=e.split(".");let i=s.value;for(const n of t){if(i==null)return;if(typeof i=="object")i=i[n];else return}return i}if(!e.includes("."))return s.value}}f("sl-input",A);f("sl-textarea",K);f("sl-button",Q);f("sl-select",_);f("sl-checkbox",P);f("sl-switch",G);f("sl-radio-group",X);f("sl-option",Y);f("sl-dialog",Z);f("div[data-tabulator]",ee);
