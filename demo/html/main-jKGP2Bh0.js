var G=Object.defineProperty;var Y=(o,e,t)=>e in o?G(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var c=(o,e,t)=>Y(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const z={high:0,medium:1,low:2};class J{constructor(e){c(this,"pendingMessages",[]);c(this,"debounceTimer",null);c(this,"insertionOrder",0);c(this,"userEvent",!1);c(this,"sendFn");c(this,"debounceInterval",10);this.sendFn=e}enqueue(e,t="medium"){this.pendingMessages.push({message:e,priority:t,order:this.insertionOrder++}),this.startDebounce()}enqueueAndFlush(e,t="high"){this.pendingMessages.push({message:e,priority:t,order:this.insertionOrder++}),this.userEvent=!0,this.flushNow()}flush(){if(this.pendingMessages.length===0){this.userEvent=!1;return}this.pendingMessages.sort((s,i)=>{const n=z[s.priority]-z[i.priority];return n!==0?n:s.order-i.order});const e=this.pendingMessages.map(s=>s.message),t={userEvent:this.userEvent,messages:e};this.pendingMessages=[],this.insertionOrder=0,this.userEvent=!1,this.sendFn(JSON.stringify(t))}createDebounceTimer(){return setTimeout(()=>{this.debounceTimer=null,this.flush()},this.debounceInterval)}startDebounce(){this.cancelDebounce(),this.debounceTimer=this.createDebounceTimer()}ensureDebounceStarted(){this.debounceTimer===null&&(this.debounceTimer=this.createDebounceTimer())}cancelDebounce(){this.debounceTimer!==null&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}flushNow(){this.cancelDebounce(),this.flush()}get pendingCount(){return this.pendingMessages.length}}class X{constructor(e){c(this,"ws",null);c(this,"sessionId");c(this,"reconnectAttempts",0);c(this,"maxReconnectAttempts",5);c(this,"reconnectDelay",1e3);c(this,"messageHandlers",[]);c(this,"errorHandlers",[]);c(this,"connectHandlers",[]);c(this,"disconnectHandlers",[]);c(this,"nextVarId",2);c(this,"batcher");this.sessionId=e,this.batcher=new J(t=>this.sendRaw(t))}connect(){return new Promise((e,t)=>{const i=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/${this.sessionId}`;this.ws=new WebSocket(i),this.ws.onopen=()=>{this.reconnectAttempts=0,this.connectHandlers.forEach(n=>n()),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);if(this.batcher.ensureDebounceStarted(),Array.isArray(r)){console.log("RECEIVED BATCH",r.length,"messages");for(const l of r)this.processIncomingItem(l)}else this.processIncomingItem(r)}catch(r){console.error("Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("WebSocket error:",n),t(new Error("WebSocket connection failed"))},this.ws.onclose=()=>{this.disconnectHandlers.forEach(n=>n()),this.attemptReconnect()}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.errorHandlers.forEach(t=>t("Max reconnection attempts reached"));return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect().catch(()=>{})},e)}processIncomingItem(e){!e||typeof e!="object"||(console.log("RECEIVED MESSAGE",JSON.stringify(e)),this.handleMessage(e))}handleMessage(e){this.messageHandlers.forEach(t=>t(e))}createVarId(){return this.nextVarId++}sendRaw(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.error("WebSocket not connected")}send(e,t="medium",s=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.error("WebSocket not connected");return}s?this.batcher.enqueueAndFlush(e,t):this.batcher.enqueue(e,t)}onMessage(e){return this.messageHandlers.push(e),()=>{const t=this.messageHandlers.indexOf(e);t>=0&&this.messageHandlers.splice(t,1)}}onError(e){return this.errorHandlers.push(e),()=>{const t=this.errorHandlers.indexOf(e);t>=0&&this.errorHandlers.splice(t,1)}}onConnect(e){return this.connectHandlers.push(e),()=>{const t=this.connectHandlers.indexOf(e);t>=0&&this.connectHandlers.splice(t,1)}}onDisconnect(e){return this.disconnectHandlers.push(e),()=>{const t=this.disconnectHandlers.indexOf(e);t>=0&&this.disconnectHandlers.splice(t,1)}}disconnect(){this.batcher.flushNow(),this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}}class Q{constructor(e){c(this,"variables",new Map);c(this,"errors",new Map);c(this,"watchers",new Map);c(this,"errorWatchers",new Map);c(this,"connection");this.connection=e,e.onMessage(t=>{if(t.type==="update"){const s=t.data;this.handleUpdate(s.varId,s.value,s.properties)}else if(t.type==="destroy"){const s=t.data;this.handleDestroy(s.varId)}else if(t.type==="error"){const s=t.data;s.varId!==void 0&&this.handleError(s.varId,s.code,s.description)}})}handleUpdate(e,t,s,i){let n=this.variables.get(e);n||(n={varId:e,value:void 0,properties:{}},i!==void 0&&(n.parentId=i),this.variables.set(e,n)),console.log("handleUpdate varId",e,"parentId",n.parentId),t!==void 0&&(n.value=t),s&&(n.properties={...n.properties,...s}),this.errors.has(e)&&(this.errors.delete(e),this.notifyErrorWatchers(e,null));const r=this.watchers.get(e);r&&r.forEach(l=>l(n,t,s))}handleError(e,t,s){const i={code:t,description:s};this.errors.set(e,i),this.notifyErrorWatchers(e,i)}notifyErrorWatchers(e,t){const s=this.errorWatchers.get(e);s&&s.forEach(i=>i(t))}handleDestroy(e){this.variables.delete(e),this.watchers.delete(e)}watch(e,t,s){let i=this.watchers.get(e);return i||(i=new Set,this.watchers.set(e,i),s&&this.connection.send({type:"watch",data:{varId:e}})),i.add(t),()=>{i.delete(t),i.size===0&&(this.watchers.delete(e),this.connection.send({type:"unwatch",data:{varId:e}}))}}watchErrors(e,t){let s=this.errorWatchers.get(e);s||(s=new Set,this.errorWatchers.set(e,s)),s.add(t);const i=this.errors.get(e)??null;return t(i),()=>{s.delete(t),s.size===0&&this.errorWatchers.delete(e)}}getError(e){return this.errors.get(e)??null}get(e){return this.variables.get(e)}create(e){const t=this.connection.createVarId(),s={varId:t,value:void 0,properties:e.properties||{}};return e.parentId!==void 0&&(s.parentId=e.parentId),e.widget&&(s.widget=e.widget),this.variables.set(t,s),console.log("SENDING CREATE id=",t),this.connection.send({type:"create",data:{id:t,...e}}),t}update(e,t,s){var l;const i=this.variables.get(e),n=(l=i==null?void 0:i.properties)==null?void 0:l.access,r=n==="action";i&&t!==void 0&&!(r||n==="w")&&i.value===t||(i&&(t!==void 0&&(i.value=t),s&&(i.properties={...i.properties,...s})),this.connection.send({type:"update",data:{varId:e,value:t,properties:s}},"medium",r))}destroy(e){this.connection.send({type:"destroy",data:{varId:e}})}sendError(e,t,s){this.connection.send({type:"error",data:{varId:e,code:t,description:s}}),this.handleError(e,t,s)}}let Z=1;function $(){return`ui-${Z++}`}function H(o){return o.id||(o.id=$()),o.id}const ee={"SL-BADGE":!0},te=new Set(["SL-COPY-BUTTON","SL-OPTION","SL-PROGRESS-BAR","SL-PROGRESS-RING","SL-QR-CODE"]),se=new Set(["INPUT","TEXTAREA","SL-INPUT","SL-TEXTAREA"]);function ie(o){return!se.has(o.tagName)}function ne(o){return o instanceof HTMLElement&&o.nodeName.startsWith("SL-")}function O(o){const[e,t]=o.split("?"),s=e.split("."),i={};if(t){const n=new URLSearchParams(t),r=h=>{const a=n.get(h);return a===""?"true":a};n.has("create")&&(i.create=r("create")),n.has("wrapper")&&(i.wrapper=r("wrapper")),n.has("item")&&(i.item=r("item"));const l={};n.forEach((h,a)=>{a!=="create"&&a!=="wrapper"&&a!=="item"&&(l[a]=h===""?"true":h)}),Object.keys(l).length>0&&(i.props=l)}return{path:e,segments:s,options:i}}function T(o){const e={};return o.create&&(e.create=o.create),o.wrapper&&(e.wrapper=o.wrapper),o.item&&(e.item=o.item),o.props&&Object.assign(e,o.props),e}class q{constructor(e){c(this,"elementId");c(this,"variables",new Map);c(this,"unbindHandlers",new Map);c(this,"views",[]);c(this,"scrollOnOutput",!1);e.id||(e.id=H(e)),this.elementId=e.id}addView(e){this.views.includes(e)||this.views.push(e)}removeView(e){const t=this.views.indexOf(e);t>=0&&this.views.splice(t,1)}scrollToBottom(){const e=this.getElement();e&&e.scrollHeight>e.clientHeight&&(e.scrollTop=e.scrollHeight)}registerBinding(e,t,s){this.variables.set(e,t),this.unbindHandlers.set(e,s)}getVariableId(e){return this.variables.get(e)}hasBinding(e){return this.variables.has(e)}getElement(){return document.getElementById(this.elementId)}unbindAll(){var e,t;for(const s of this.unbindHandlers.values())s();this.unbindHandlers.clear(),this.variables.clear();for(let s=this.views.length-1;s>=0;s--)(t=(e=this.views[s]).onWidgetUnbind)==null||t.call(e);this.views=[]}}const R=class R{constructor(e){c(this,"store");c(this,"widgets",new Map);c(this,"pendingScrollNotifications",new Set);c(this,"scrollProcessingScheduled",!1);this.store=e}addScrollNotification(e){this.pendingScrollNotifications.add(e),this.scrollProcessingScheduled||(this.scrollProcessingScheduled=!0,queueMicrotask(()=>{this.scrollProcessingScheduled=!1,this.processScrollNotifications()}))}processScrollNotifications(){let e=new Set(this.pendingScrollNotifications);for(this.pendingScrollNotifications.clear();e.size>0;){const t=new Set;for(const s of e){const i=this.store.get(s);if(!i)continue;const n=i.properties.elementId;if(n){const r=this.widgets.get(n);if(r!=null&&r.scrollOnOutput){r.scrollToBottom();continue}}i.parentId&&t.add(i.parentId)}e=t}}getWidget(e){return this.widgets.get(e)}getView(e){const t=this.widgets.get(e);return t==null?void 0:t.views[0]}getOrCreateWidget(e){let t=this.widgets.get(e);if(!t){const s=document.getElementById(e);s&&(t=new q(s),this.widgets.set(e,t))}return t}setViewForElement(e,t){const s=this.getOrCreateWidget(e);s&&s.addView(t)}bindElement(e,t){let s=!1;const i=new q(e),n=e.getAttribute("ui-value");n&&(this.createValueBinding(e,t,n,i),s=!0);for(const a of Array.from(e.attributes))if(a.name.startsWith("ui-attr-")){const p=a.name.substring(8);this.createAttrBinding(t,a.value,p,i),s=!0}for(const a of Array.from(e.attributes))if(a.name.startsWith("ui-class-")){const p=a.name.substring(9);this.createClassBinding(t,a.value,p,i),s=!0}for(const a of Array.from(e.attributes))if(a.name.startsWith("ui-style-")){const p=a.name.substring(9);this.createStyleBinding(t,a.value,p,i),s=!0}for(const a of Array.from(e.attributes))if(a.name.startsWith("ui-event-")){const p=a.name.substring(9);this.createEventBinding(e,t,a.value,p,i),s=!0}const r=e.getAttribute("ui-action");r&&(this.createActionBinding(e,t,r,i),s=!0);const l=e.getAttribute("ui-code");l&&(this.createCodeBinding(t,l,i),s=!0);const h=e.getAttribute("ui-html");h&&(this.createHtmlBinding(t,h,i),s=!0),s&&this.widgets.set(i.elementId,i);for(const a of Array.from(e.children))this.bindElement(a,t)}unbindElement(e){const t=e.id;if(t){const s=this.widgets.get(t);s&&(s.unbindAll(),this.widgets.delete(t))}for(const s of Array.from(e.children))this.unbindElement(s)}createValueBinding(e,t,s,i){var C,K,U;const n=O(s),r=T(n.options);r.path=n.segments.join(".");const l=((C=n.options.props)==null?void 0:C.keypress)==="true",h=((K=n.options.props)==null?void 0:K.scrollOnOutput)==="true";h&&(i.scrollOnOutput=!0);let a=null,p=null,f=null;const m=!(e instanceof HTMLButtonElement)&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement||ne(e)||"value"in e&&!(e.nodeName in ee)),u=i.elementId,S=()=>{if(h){const g=document.getElementById(u);g&&g.scrollHeight>g.clientHeight&&(g.scrollTop=g.scrollHeight)}},d=ie(e),I=m?g=>{const w=document.getElementById(u);if(!w)return;if(w.tagName.toLowerCase()==="sl-select"){const j=g==null?"":String(g);w.value=j,j===""&&setTimeout(()=>{w.displayLabel=""},0)}else typeof g=="number"?w.value=g:g==null||g===""?w.value="":w.value=g.toString();S(),d&&this.addScrollNotification(t)}:g=>{const w=document.getElementById(u);w&&(w.textContent=(g==null?void 0:g.toString())??"",S(),d&&this.addScrollNotification(t))},k=g=>{const w=document.getElementById(u);w&&(g?(w.classList.add("ui-error"),w.setAttribute("ui-error-code",g.code),w.setAttribute("ui-error-description",g.description)):(w.classList.remove("ui-error"),w.removeAttribute("ui-error-code"),w.removeAttribute("ui-error-description")))},B=g=>{if(a!==null){const w=g.target;this.store.update(a,w.value)}};if((U=n.segments[n.segments.length-1])==null?void 0:U.endsWith("()")){if(r.access===void 0)r.access="r";else if(r.access!=="r"&&r.access!=="action"&&r.access!=="rw"){console.error(`Invalid access '${r.access}' for method call path '${s}' - must be 'r', 'action', or 'rw'`);return}}else(!m&&r.access===void 0||te.has(e.nodeName)&&r.access===void 0)&&(r.access="r");const A=this.store.create({parentId:t,properties:r,widget:i});a=A,p=this.store.watch(A,(g,w)=>I(w)),f=this.store.watchErrors(A,k);const y=this.store.get(A);y&&I(y.value),i.registerBinding("ui-value",A,()=>{p&&p(),f&&f(),L&&e.removeEventListener(L,B),V&&e.removeEventListener(V,P),e.removeEventListener("ui-value-change",M),this.store.destroy(A),e.classList.remove("ui-error"),e.removeAttribute("ui-error-code"),e.removeAttribute("ui-error-description")});const b=e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement,E=e.tagName.toLowerCase(),N=E==="sl-input"||E==="sl-textarea"||E==="sl-select";let L=null,V=null;b&&(L=l?"input":"blur"),N&&(V=l?"sl-input":"sl-change"),L&&e.addEventListener(L,B);const P=g=>{if(a!==null){const w=g.target;this.store.update(a,w.value)}};V&&e.addEventListener(V,P);const M=g=>{const w=g;a!==null&&this.store.update(a,w.detail.value)};e.addEventListener("ui-value-change",M)}createAttrBinding(e,t,s,i){var v;const n=O(t),r=T(n.options);r.path=n.segments.join("."),((v=n.options.props)==null?void 0:v.scrollOnOutput)==="true"&&(i.scrollOnOutput=!0),r.access||(r.access="r");const l=i.elementId,h=m=>{const u=document.getElementById(l);u&&(m!=null&&m!==!1?u.setAttribute(s,m.toString()):u.removeAttribute(s))},a=this.store.create({parentId:e,properties:r,widget:i}),p=this.store.watch(a,(m,u)=>h(u)),f=this.store.get(a);f&&h(f.value),i.registerBinding(`ui-attr-${s}`,a,()=>{p(),this.store.destroy(a)})}createClassBinding(e,t,s,i){var v;const n=O(t),r=T(n.options);r.path=n.segments.join("."),((v=n.options.props)==null?void 0:v.scrollOnOutput)==="true"&&(i.scrollOnOutput=!0),r.access||(r.access="r");const l=i.elementId,h=m=>{const u=document.getElementById(l);u&&(m?u.classList.add(s):u.classList.remove(s))},a=this.store.create({parentId:e,properties:r,widget:i}),p=this.store.watch(a,(m,u)=>h(u)),f=this.store.get(a);f&&h(f.value),i.registerBinding(`ui-class-${s}`,a,()=>{p(),this.store.destroy(a)})}createStyleBinding(e,t,s,i){var v;const n=O(t),r=T(n.options);r.path=n.segments.join("."),((v=n.options.props)==null?void 0:v.scrollOnOutput)==="true"&&(i.scrollOnOutput=!0),r.access||(r.access="r");const l=i.elementId,h=m=>{const u=document.getElementById(l);u&&(m!=null?u.style.setProperty(s,m.toString()):u.style.removeProperty(s))},a=this.store.create({parentId:e,properties:r,widget:i}),p=this.store.watch(a,(m,u)=>h(u)),f=this.store.get(a);f&&h(f.value),i.registerBinding(`ui-style-${s}`,a,()=>{p(),this.store.destroy(a)})}createCodeBinding(e,t,s){var v;const i=O(t),n=T(i.options);n.path=i.segments.join("."),((v=i.options.props)==null?void 0:v.scrollOnOutput)==="true"&&(s.scrollOnOutput=!0),n.access||(n.access="r");const r=s.elementId;let l=null;const h=m=>{if(typeof m!="string"||!m)return;const u=document.getElementById(r);if(u)try{const S=new Function("element","value","variable","store",m),d=l!==null?this.store.get(l):null;S(u,d==null?void 0:d.value,d,this.store)}catch(S){console.error("Error executing ui-code:",S)}},a=this.store.create({parentId:e,properties:n,widget:s});l=a;const p=this.store.watch(a,(m,u)=>h(u)),f=this.store.get(a);f!=null&&f.value&&h(f.value),s.registerBinding("ui-code",a,()=>{p(),this.store.destroy(a)})}createHtmlBinding(e,t,s){var x,A;const i=O(t),n=T(i.options);n.path=i.segments.join("."),((x=i.options.props)==null?void 0:x.scrollOnOutput)==="true"&&(s.scrollOnOutput=!0),n.access||(n.access="r");const r=((A=i.options.props)==null?void 0:A.replace)==="true",l=s.elementId;let h=[l];function a(y){const b=document.createElement("div");return b.innerHTML=y,Array.from(b.childNodes)}function p(y){return y.map((b,E)=>(b.id=E===0?l:$(),b.id))}function f(){const y=document.createElement("span");return y.id=l,y.style.display="none",y}function v(y){const b=document.createElement("span");b.id=l;for(const E of y)b.appendChild(E);return b}function m(y,b,E){for(const N of b)y.insertBefore(N,E)}const d=r?y=>{var M;const b=(y??"").toString(),E=document.getElementById(h[0]);if(!(E!=null&&E.parentNode))return;const N=E.parentNode,L=E.nextSibling;for(const C of h)(M=document.getElementById(C))==null||M.remove();const V=a(b),P=V.filter(C=>C instanceof Element);V.length===0?(N.insertBefore(f(),L),h=[l]):P.length===0?(N.insertBefore(v(V),L),h=[l]):(h=p(P),m(N,V,L)),this.addScrollNotification(e)}:y=>{const b=document.getElementById(l);b&&(b.innerHTML=(y??"").toString(),this.addScrollNotification(e))},I=this.store.create({parentId:e,properties:n,widget:s}),k=this.store.watch(I,(y,b)=>d(b)),B=this.store.get(I);B&&d(B.value),s.registerBinding("ui-html",I,()=>{if(k(),this.store.destroy(I),r)for(const y of h){const b=document.getElementById(y);b&&b.remove()}})}normalizeKeyName(e){const t={enter:"Enter",escape:"Escape",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",tab:"Tab",space:" "},s=e.toLowerCase();return t[s]??s}matchesTargetKey(e,t){const s=this.normalizeKeyName(t);return s.length===1?e.key.toLowerCase()===s.toLowerCase():e.key===s}parseKeypressAttribute(e){const t=e.toLowerCase().split("-"),s=new Set;let i="";for(const n of t)R.MODIFIER_KEYS.has(n)?s.add(n):i=n;return{modifiers:s,key:i}}matchesModifiers(e,t){const s=new Set;if(e.ctrlKey&&s.add("ctrl"),e.shiftKey&&s.add("shift"),e.altKey&&s.add("alt"),e.metaKey&&s.add("meta"),s.size!==t.size)return!1;for(const i of t)if(!s.has(i))return!1;return!0}syncValueBeforeEvent(e,t){const s=t.getVariableId("ui-value");if(s===void 0)return;const i=e.value;if(i===void 0)return;const n=this.store.get(s);n&&n.value!==i&&this.store.update(s,i)}createEventBinding(e,t,s,i,n){if(i.startsWith("keypress-")){this.createKeypressBinding(e,t,s,i,n);return}const r=O(s),l=r.segments.join("."),h=T(r.options);h.path=l,h.access||(h.access="action"),h.priority||(h.priority="low");const a=f=>{p!==null&&(this.syncValueBeforeEvent(e,n),this.store.update(p,null))},p=this.store.create({parentId:t,properties:h,widget:n});e.addEventListener(i,a),n.registerBinding(`ui-event-${i}`,p,()=>{e.removeEventListener(i,a),this.store.destroy(p)})}createKeypressBinding(e,t,s,i,n){const r=i.substring(9);if(!r){console.error("Invalid keypress binding - missing key name:",i);return}const{modifiers:l,key:h}=this.parseKeypressAttribute(r);if(!h){console.error("Invalid keypress binding - no key found:",i);return}const a=O(s),p=T(a.options),f=a.segments.join(".");p.path=f;const v=f.match(/\(\)$/),m=f.match(/\(_\)$/);(v||m)&&(p.access="action");const u=this.store.create({parentId:t,properties:p,widget:n}),S=d=>{const I=d;this.matchesTargetKey(I,h)&&this.matchesModifiers(I,l)&&(this.syncValueBeforeEvent(e,n),this.store.update(u,v?null:h.toLowerCase()))};e.addEventListener("keydown",S),n.registerBinding(`ui-event-${i}`,u,()=>{e.removeEventListener("keydown",S),this.store.destroy(u)})}createActionBinding(e,t,s,i){const n=O(s),r=n.segments.join("."),l=T(n.options);l.path=r,l.access||(l.access="action");const h=r.endsWith("(_)"),a=this.store.create({parentId:t,properties:l,widget:i}),p=f=>{f.preventDefault();const v=h?e.value??null:null;this.store.update(a,v)};e.addEventListener("click",p),i.registerBinding("ui-action",a,()=>{e.removeEventListener("click",p),this.store.destroy(a)})}};c(R,"MODIFIER_KEYS",new Set(["ctrl","shift","alt","meta"]));let D=R;function re(o){const e=o.indexOf(".");return e===-1?null:{type:o.substring(0,e),namespace:o.substring(e+1)}}function _(o,e){return`${o}.${e}`}function oe(o){const e=document.createElement("div");if(e.innerHTML=o.trim(),e.children.length!==1)return null;const t=e.children[0];return t instanceof HTMLTemplateElement?t:null}function ae(o,e){const t=re(o);if(!t)return null;const s=oe(e);return s?{key:o,type:t.type,namespace:t.namespace,template:s}:null}function ce(o){return o.template.content.cloneNode(!0)}function le(o){return Array.from(o.querySelectorAll("script"))}function de(o){for(const e of o){const t=document.createElement("script");t.type="text/javascript",t.textContent=e.textContent,e.id&&(t.id=e.id),t.className=e.className,e.replaceWith(t)}}class he{constructor(){c(this,"viewdefs",new Map);c(this,"pendingViews",new Map);c(this,"errorHandler");c(this,"viewLookup")}setErrorHandler(e){this.errorHandler=e}setViewLookup(e){this.viewLookup=e}store(e,t){const s=ae(e,t);return s?(this.viewdefs.set(e,s),!0):(this.errorHandler&&this.errorHandler(e,"Invalid viewdef: must be a single <template> element"),!1)}processViewdefs(e){const t=[];for(const[s,i]of Object.entries(e)){const n=this.viewdefs.has(s);this.store(s,i)&&n&&t.push(s)}this.processPendingViews();for(const s of t)this.rerenderViewsForKey(s)}rerenderViewsForKey(e){if(!this.viewLookup){console.warn("[ViewdefStore] Hot-reload: viewLookup not set, cannot re-render");return}const t=`[ui-viewdef="${e}"]`,s=document.querySelectorAll(t);console.log(`[ViewdefStore] Hot-reload: re-rendering ${s.length} views for ${e}`);for(const i of s)if(i instanceof HTMLElement&&i.id){const n=this.viewLookup(i.id);if(n)try{n.forceRender()}catch(r){console.error(`[ViewdefStore] Hot-reload: error re-rendering view ${i.id}:`,r)}else console.warn(`[ViewdefStore] Hot-reload: no view found for element ${i.id}`)}}get(e,t,s){if(t){const n=_(e,t),r=this.viewdefs.get(n);if(r)return r}if(s){const n=_(e,s),r=this.viewdefs.get(n);if(r)return r}const i=_(e,"DEFAULT");return this.viewdefs.get(i)}getByKey(e){return this.viewdefs.get(e)}has(e,t){return this.get(e,t)!==void 0}addPendingView(e){this.pendingViews.set(e.id,e)}removePendingView(e){this.pendingViews.delete(e)}processPendingViews(){const e=[];for(const[t,s]of this.pendingViews)s.render()&&e.push(t);for(const t of e)this.pendingViews.delete(t)}getPendingViewCount(){return this.pendingViews.size}getViewdefCount(){return this.viewdefs.size}getKeys(){return Array.from(this.viewdefs.keys())}clear(){this.viewdefs.clear()}}function ue(o){const e=O(o);return{path:e.path,wrapper:e.options.wrapper,item:e.options.item,props:e.options.props??{}}}class pe{constructor(e,t,s,i){c(this,"elementId");c(this,"itemWrapper");c(this,"variableId",null);c(this,"itemViews",[]);c(this,"exemplarHtml");c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"binding");c(this,"_scrollOnOutput",!1);c(this,"pathConfig",null);this.elementId=H(e),this.itemWrapper=e.getAttribute("ui-item-wrapper")||void 0,this.viewdefStore=t,this.variableStore=s,this.binding=i;const n=e.firstElementChild;n instanceof HTMLElement?(this.exemplarHtml=n.outerHTML,e.removeChild(n)):this.exemplarHtml="<div></div>"}getElement(){return document.getElementById(this.elementId)}setScrollOnOutput(e){this._scrollOnOutput=e}registerWidget(){if(!this.binding)return;this.binding.setViewForElement(this.elementId,{forceRender:()=>this.update()});const e=this.binding.getWidget(this.elementId);e&&this._scrollOnOutput&&(e.scrollOnOutput=!0)}notifyParentRendered(){if(!this.binding||this.variableId===null)return;const e=this.variableStore.get(this.variableId);e!=null&&e.parentId&&this.binding.addScrollNotification(e.parentId)}scrollToBottom(){if(!this.binding)return;const e=this.binding.getWidget(this.elementId);e!=null&&e.scrollOnOutput&&e.scrollToBottom()}setExemplar(e){this.exemplarHtml=e.outerHTML}setPathConfig(e){this.pathConfig=ue(e),(this.pathConfig.props.scrollOnOutput==="true"||this.pathConfig.props.scrollOnOutput==="")&&(this._scrollOnOutput=!0,delete this.pathConfig.props.scrollOnOutput)}getVariableProperties(){if(!this.pathConfig)return{};const e={...this.pathConfig.props};return this.pathConfig.item&&(e.item=this.pathConfig.item),e}getBasePath(){var e;return((e=this.pathConfig)==null?void 0:e.path)||""}resolveNamespace(e,t){const s=e.closest("[ui-namespace]"),i=this.getElement();return s&&(i!=null&&i.contains(s))?s.getAttribute("ui-namespace")||void 0:t.properties.namespace}setVariable(e){this.unwatch&&(this.unwatch(),this.unwatch=null),this.variableId=e,this.registerWidget(),this.unwatch=this.variableStore.watch(e,()=>{this.update()}),this.update()}update(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);if(!e)return;const t=e.value;if(!Array.isArray(t)){this.clear();return}for(;this.itemViews.length<t.length;){const s=this.itemViews.length,i=this.createItemView();this.itemViews.push(i),this.createItemVariable(i,s,e)}for(;this.itemViews.length>t.length;)this.itemViews.pop().destroy();this.scrollToBottom(),this.notifyParentRendered()}createItemVariable(e,t,s){const i=s.parentId?this.variableStore.get(s.parentId):void 0,r={path:this.itemWrapper?`${t}?wrapper=${this.itemWrapper}`:String(t),elementId:e.elementId};i!=null&&i.properties.itemWrapper&&(r.wrapper=i.properties.itemWrapper);const l=e.getElement();if(l){const a=this.resolveNamespace(l,s);a&&(r.namespace=a)}s.properties.fallbackNamespace&&(r.fallbackNamespace=s.properties.fallbackNamespace);const h=this.variableStore.create({parentId:this.variableId,properties:r});e.setVariable(h)}createItemView(){var s;const e=document.createElement("template");e.innerHTML=this.exemplarHtml;const t=e.content.firstElementChild;return(s=this.getElement())==null||s.appendChild(t),new W(t,this.viewdefStore,this.variableStore,this.binding)}clear(){for(const t of this.itemViews)t.destroy();this.itemViews=[];const e=this.getElement();e&&e.replaceChildren()}getCount(){return this.itemViews.length}getViewElement(e){var t;return((t=this.itemViews[e])==null?void 0:t.getElement())??null}getViewIds(){return this.itemViews.map(e=>e.elementId)}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.clear(),this.variableId!==null&&(this.variableStore.destroy(this.variableId),this.variableId=null)}}function fe(o,e,t,s){const i=new pe(o,e,t,s),n=o.getAttribute("ui-viewlist");return n&&i.setPathConfig(n),i}function ge(o,e,t){const s=o.closest("[ui-namespace]"),i=t.get(e),n=i==null?void 0:i.properties.namespace,r=i==null?void 0:i.properties.elementId,l=r?document.getElementById(r):null;if(s&&l&&n)return l.contains(s)?s.getAttribute("ui-namespace")||void 0:n;if(s)return s.getAttribute("ui-namespace")||void 0;if(n)return n}function me(o,e,t,s){const i=o.getAttribute("ui-namespace");if(i)t.namespace=i;else{const r=ge(o,e,s);r&&(t.namespace=r)}const n=s.get(e);!t.fallbackNamespace&&(n!=null&&n.properties.fallbackNamespace)&&(t.fallbackNamespace=n.properties.fallbackNamespace),t.access||(t.access="r")}const we=`
.ui-new-view {
  display: none !important;
}
`;(function(){if(document.getElementById("ui-no-flash-style"))return;const e=document.createElement("style");e.id="ui-no-flash-style",e.textContent=we,document.head.appendChild(e)})();const ve=new Set(["ui-new-view","ui-obsolete-view"]),be="ui-view-";let ye=1;class W{constructor(e,t,s,i){c(this,"elementId");c(this,"viewClass");c(this,"bufferTimeoutId");c(this,"valueType","");c(this,"variableId",null);c(this,"rendered",!1);c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"binding");c(this,"viewLists",[]);c(this,"childViews",[]);c(this,"_scrollOnOutput",!1);c(this,"viewUnbindHandlers",[]);c(this,"originalClass",null);c(this,"originalStyle",null);this.elementId=H(e),this.viewClass=`ui-view-${ye++}`;const n=e.getAttribute("class");this.originalClass=n&&n.split(/\s+/).filter(r=>r&&!r.startsWith(be)&&!ve.has(r)).join(" ")||null,this.originalStyle=e.getAttribute("style"),this.viewdefStore=t,this.variableStore=s,this.binding=i}getElement(){return document.getElementById(this.elementId)}getElements(){var t;const e=(t=document.getElementById(this.elementId))==null?void 0:t.parentElement;return e?[...e.querySelectorAll(`:scope > .${this.viewClass}`)]:[]}setScrollOnOutput(e){this._scrollOnOutput=e}notifyParentRendered(){if(!this.binding||this.variableId===null)return;const e=this.variableStore.get(this.variableId);e!=null&&e.parentId&&this.binding.addScrollNotification(e.parentId)}getNamespace(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);return e==null?void 0:e.properties.namespace}getFallbackNamespace(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);return e==null?void 0:e.properties.fallbackNamespace}setVariable(e,t){this.unwatch&&(this.unwatch(),this.unwatch=null),this.variableId=e,this.rendered=!1,this.unwatch=this.variableStore.watch(e,(s,i,n)=>{this.render()},t),this.render()}getViewdefKey(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);if(!e)return;const t=e.properties.type;if(!t)return;const s=this.getNamespace(),i=this.getFallbackNamespace(),n=this.viewdefStore.get(t,s,i);return n==null?void 0:n.key}render(){var S;if(this.variableId===null)return!1;const e=this.variableStore.get(this.variableId);if(!e)return this.markPending(),!1;const t=e.properties.type;if(!t)return this.markPending(),!1;const s=this.getNamespace(),i=this.getFallbackNamespace(),n=this.viewdefStore.get(t,s,i);if(!n)return this.markPending(),!1;if(this.rendered&&t===this.valueType)return!1;const r=this.getElement();if(!r)return console.error("View element not found:",this.elementId),!1;const l=r.parentNode;if(!l)return console.error("View element has no parent:",this.elementId),!1;const h=l.closest(".ui-new-view")!==null;let a=this.getElements();a.length===0&&(a=[r]);const p=a[a.length-1].nextSibling;let f=[];if(this.binding){const d=this.binding.getWidget(this.elementId);if(d){const I=d.views.indexOf(this);I>=0&&(f=d.views.slice(I+1),d.views.length=I+1)}}if(this.clearChildren(),h)for(const d of a)d.remove();else for(const d of a)d.removeAttribute("id"),d.classList.add(this.viewClass,"ui-obsolete-view");const v=ce(n),m=le(v),u=Array.from(v.children);if(u.length===0)return console.error("Viewdef has no root elements:",n.key),!1;u[0].id=this.elementId;for(let d=1;d<u.length;d++)u[d].id=$();if(this.originalClass)for(const d of this.originalClass.split(/\s+/))d&&u[0].classList.add(d);if(this.originalStyle){const d=u[0].getAttribute("style")||"",I=d?`${d}; ${this.originalStyle}`:this.originalStyle;u[0].setAttribute("style",I)}for(const d of u)d.classList.add(this.viewClass),h||d.classList.add("ui-new-view");u[0].setAttribute("ui-viewdef",n.key),l.insertBefore(v,p);for(const d of u)this.processViewLists(d,this.variableId),this.processChildViews(d,this.variableId);if(this.binding)for(const d of u)this.binding.bindElement(d,this.variableId);for(const d of f)(S=d.onWidgetUnbind)==null||S.call(d);if(this.rendered=!0,this.valueType=t,this.binding&&this.binding.setViewForElement(this.elementId,this),this.removePending(),this._scrollOnOutput&&this.binding){const d=this.binding.getWidget(this.elementId);d&&this._scrollOnOutput&&(d.scrollOnOutput=!0)}return!h&&!this.bufferTimeoutId&&(this.bufferTimeoutId=window.setTimeout(()=>{if(document.querySelectorAll(`.${this.viewClass}.ui-obsolete-view`).forEach(d=>d.remove()),document.querySelectorAll(`.${this.viewClass}.ui-new-view`).forEach(d=>{d.classList.remove("ui-new-view")}),de(m),this._scrollOnOutput&&this.binding){const d=this.binding.getWidget(this.elementId);d!=null&&d.scrollOnOutput&&d.scrollToBottom()}this.notifyParentRendered(),this.bufferTimeoutId=void 0},100)),!0}processViewLists(e,t){this.processAttributeElements(e,"ui-viewlist",s=>{this.setupViewList(s,t)})}processAttributeElements(e,t,s){if(e instanceof HTMLElement&&e.hasAttribute(t)){s(e);return}for(const i of e.querySelectorAll(`[${t}]`))i instanceof HTMLElement&&s(i)}buildNamespaceProperties(e,t,s){me(e,t,s,this.variableStore)}setupViewList(e,t){const s=fe(e,this.viewdefStore,this.variableStore,this.binding);if(e.getAttribute("ui-viewlist")){const n=s.getBasePath(),r=H(e),l={path:n,elementId:r,...s.getVariableProperties()};this.buildNamespaceProperties(e,t,l);const h=this.variableStore.create({parentId:t,properties:l});s.setVariable(h)}this.viewLists.push(s)}processChildViews(e,t){this.processAttributeElements(e,"ui-view",s=>{this.setupChildView(s,t)})}setupChildView(e,t){const s=new W(e,this.viewdefStore,this.variableStore,this.binding),i=e.getAttribute("ui-view");if(i){const n=O(i),r=n.options.props??{};delete n.options.props,r.scrollOnOutput==="true"&&s.setScrollOnOutput(!0),delete r.scrollOnOutput;const l=H(e),h={path:n.path,elementId:l,...n.options,...r};this.buildNamespaceProperties(e,t,h);const a=this.variableStore.create({parentId:t,properties:h});s.setVariable(a)}this.childViews.push(s)}clearChildren(){for(const e of this.viewLists)e.destroy();this.viewLists=[];for(const e of this.childViews)e.destroy();this.childViews=[]}clear(){this.clearChildren();const e=this.getElements();for(const t of e)t.remove();this.rendered=!1}markPending(){this.viewdefStore.addPendingView({id:this.elementId,render:()=>this.render()})}removePending(){this.viewdefStore.removePendingView(this.elementId)}isRendered(){return this.rendered}forceRender(){this.rendered=!1,this.valueType="",this.render()}onWidgetUnbind(){for(const e of this.viewUnbindHandlers)e();this.viewUnbindHandlers=[]}getVariableId(){return this.variableId}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.bufferTimeoutId&&(clearTimeout(this.bufferTimeoutId),this.bufferTimeoutId=void 0),this.removePending(),this.clear(),this.variableId!==null&&(this.variableStore.destroy(this.variableId),this.variableId=null)}}const Ie=1;class Ee{constructor(e,t,s,i){c(this,"elementId");c(this,"variableId",Ie);c(this,"namespace");c(this,"view",null);c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"binding");this.elementId=H(e),this.namespace=e.getAttribute("ui-namespace")||"DEFAULT",this.viewdefStore=t,this.variableStore=s,this.binding=i}getElement(){return document.getElementById(this.elementId)}initialize(){const e=this.getElement();if(!e){console.error("AppView element not found:",this.elementId);return}this.view=new W(e,this.viewdefStore,this.variableStore,this.binding),this.view.setVariable(this.variableId,!0),this.unwatch=this.variableStore.watch(this.variableId,(t,s,i)=>{this.handleRootUpdate(s,i??{})},!1)}handleRootUpdate(e,t){console.log("handleRootUpdate called, props:",Object.keys(t));const s=t.viewdefs;if(s){console.log("Found viewdefs property, length:",s.length);try{const i=JSON.parse(s);typeof i=="object"&&i!==null&&(console.log("Parsed viewdefs, keys:",Object.keys(i)),this.viewdefStore.processViewdefs(i))}catch(i){console.error("Failed to parse viewdefs property:",i)}}else console.log("No viewdefs property found")}getView(){return this.view}isRendered(){var e;return((e=this.view)==null?void 0:e.isRendered())??!1}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.view&&(this.view.destroy(),this.view=null)}}function F(){return document.querySelector("[ui-app]")}function Se(o,e,t){const s=F();if(!s)return null;const i=new Ee(s,o,e,t);return i.initialize(),i}function Oe(o){o=o.replace(/^\//,"");const e=o.indexOf("/");return e===-1?{sessionId:o,path:"/"}:{sessionId:o.substring(0,e),path:"/"+o.substring(e+1)}}function Ve(){const o=document.cookie.match(/(?:^|; )ui-session=([^;]*)/);return o?o[1]:""}function Ae(){const o=Ve();if(o)return o;const{sessionId:e}=Oe(window.location.pathname);if(!e)throw new Error("No session ID in URL or cookie");return e}class Le{constructor(){c(this,"connection");c(this,"store");c(this,"viewdefStore");c(this,"binding");c(this,"sessionId");c(this,"appView",null);this.sessionId=this.extractSessionId(),this.connection=new X(this.sessionId),this.store=new Q(this.connection),this.viewdefStore=new he,this.binding=new D(this.store),this.viewdefStore.setViewLookup(e=>this.binding.getView(e))}extractSessionId(){return Ae()}async initialize(){this.connection.onConnect(()=>{console.log("Connected to session:",this.sessionId)}),this.connection.onDisconnect(()=>{console.log("Disconnected from session")}),this.connection.onError(t=>{console.error("Connection error:",t)}),this.connection.onMessage(t=>{this.handleMessage(t)}),await this.connection.connect(),F()&&(this.appView=Se(this.viewdefStore,this.store,this.binding))}handleMessage(e){switch(e.type){case"error":const t=e.data;console.error("Server error:",t.description);break}}navigateTo(e){window.history.pushState({},"",e),this.handleNavigation()}handleNavigation(){const s="/"+window.location.pathname.split("/").filter(Boolean).slice(1).join("/");this.store.update(1,void 0,{url:s})}getStore(){return this.store}getViewdefStore(){return this.viewdefStore}getConnection(){return this.connection}getAppView(){return this.appView}getBinding(){return this.binding}updateValue(e,t){const s=this.binding.getWidget(e);if(!s)return;const i=s.getVariableId("ui-value");if(i!==void 0){if(t===void 0){const n=document.getElementById(e);t=n==null?void 0:n.value}this.store.update(i,t)}}}function Te(){const o=new Le;return o.initialize().then(()=>o)}document.addEventListener("DOMContentLoaded",()=>{F()&&Te().then(e=>{window.uiApp=e,window.uiStore=e.getStore()}).catch(console.error)});
