var W=Object.defineProperty;var F=(a,e,t)=>e in a?W(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>F(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();function O(a){return JSON.stringify(a)}const M={high:0,medium:1,low:2};class x{constructor(e){c(this,"pendingMessages",[]);c(this,"throttleTimer",null);c(this,"insertionOrder",0);c(this,"sendFn");c(this,"throttleInterval",200);this.sendFn=e}shouldBypassBatch(e){return e.type==="create"}enqueue(e,t="medium"){this.pendingMessages.push({message:e,priority:t,order:this.insertionOrder++}),this.startThrottle()}sendImmediate(e){this.sendFn(O(e))}flush(){if(this.pendingMessages.length===0)return;this.pendingMessages.sort((t,s)=>{const i=M[t.priority]-M[s.priority];return i!==0?i:t.order-s.order});const e=this.pendingMessages.map(t=>t.message);this.pendingMessages=[],this.insertionOrder=0,this.sendFn(JSON.stringify(e))}startThrottle(){this.throttleTimer===null&&(this.throttleTimer=setTimeout(()=>{this.throttleTimer=null,this.flush()},this.throttleInterval))}cancelThrottle(){this.throttleTimer!==null&&(clearTimeout(this.throttleTimer),this.throttleTimer=null)}flushNow(){this.cancelThrottle(),this.flush()}get pendingCount(){return this.pendingMessages.length}}class _{constructor(e){c(this,"ws",null);c(this,"sessionId");c(this,"reconnectAttempts",0);c(this,"maxReconnectAttempts",5);c(this,"reconnectDelay",1e3);c(this,"messageHandlers",[]);c(this,"errorHandlers",[]);c(this,"connectHandlers",[]);c(this,"disconnectHandlers",[]);c(this,"requestId",1);c(this,"createCallbacks",new Map);c(this,"batcher");this.sessionId=e,this.batcher=new x(t=>this.sendRaw(t))}connect(){return new Promise((e,t)=>{const i=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/${this.sessionId}`;this.ws=new WebSocket(i),this.ws.onopen=()=>{this.reconnectAttempts=0,this.connectHandlers.forEach(n=>n()),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);"result"in r||"error"in r&&!("type"in r)||"pending"in r||"id"in r?(console.log("RECEIVED RESPONSE",JSON.stringify(r)),this.handleResponse(r)):(console.log("RECEIVED MESSAGE",JSON.stringify(r)),this.handleMessage(r))}catch(r){console.error("Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("WebSocket error:",n),t(new Error("WebSocket connection failed"))},this.ws.onclose=()=>{this.disconnectHandlers.forEach(n=>n()),this.attemptReconnect()}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.errorHandlers.forEach(t=>t("Max reconnection attempts reached"));return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect().catch(()=>{})},e)}handleMessage(e){this.messageHandlers.forEach(t=>t(e))}handleResponse(e){const t=e.result;if(t&&typeof t=="object"&&"id"in t&&t.requestId){const s=this.createCallbacks.get(t.requestId);s&&(this.createCallbacks.delete(t.requestId),s(e))}}sendRaw(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.error("WebSocket not connected")}send(e,t="medium"){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.error("WebSocket not connected");return}this.batcher.shouldBypassBatch(e)?this.batcher.sendImmediate(e):this.batcher.enqueue(e,t)}sendAndAwaitResponse(e){return new Promise((t,s)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){s(new Error("WebSocket not connected"));return}const i=this.requestId++,n=e.data||{};n.requestId=i,e.data=n,this.createCallbacks.set(i,t),this.ws.send(O(e))})}onMessage(e){return this.messageHandlers.push(e),()=>{const t=this.messageHandlers.indexOf(e);t>=0&&this.messageHandlers.splice(t,1)}}onError(e){return this.errorHandlers.push(e),()=>{const t=this.errorHandlers.indexOf(e);t>=0&&this.errorHandlers.splice(t,1)}}onConnect(e){return this.connectHandlers.push(e),()=>{const t=this.connectHandlers.indexOf(e);t>=0&&this.connectHandlers.splice(t,1)}}onDisconnect(e){return this.disconnectHandlers.push(e),()=>{const t=this.disconnectHandlers.indexOf(e);t>=0&&this.disconnectHandlers.splice(t,1)}}disconnect(){this.batcher.flushNow(),this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}}class U{constructor(e){c(this,"variables",new Map);c(this,"errors",new Map);c(this,"watchers",new Map);c(this,"errorWatchers",new Map);c(this,"connection");this.connection=e,e.onMessage(t=>{if(t.type==="update"){const s=t.data;this.handleUpdate(s.varId,s.value,s.properties)}else if(t.type==="destroy"){const s=t.data;this.handleDestroy(s.varId)}else if(t.type==="error"){const s=t.data;s.varId!==void 0&&this.handleError(s.varId,s.code,s.description)}})}handleUpdate(e,t,s,i){let n=this.variables.get(e);n||(n={varId:e,value:void 0,properties:{}},i!==void 0&&(n.parentId=i),this.variables.set(e,n)),console.log("handleUpdate varId",e,"parentId",n.parentId),t!==void 0&&(n.value=t),s&&(n.properties={...n.properties,...s}),this.errors.has(e)&&(this.errors.delete(e),this.notifyErrorWatchers(e,null));const r=this.watchers.get(e);r&&r.forEach(o=>o(n,t,s))}handleError(e,t,s){const i={code:t,description:s};this.errors.set(e,i),this.notifyErrorWatchers(e,i)}notifyErrorWatchers(e,t){const s=this.errorWatchers.get(e);s&&s.forEach(i=>i(t))}handleDestroy(e){this.variables.delete(e),this.watchers.delete(e)}watch(e,t,s){let i=this.watchers.get(e);return i||(i=new Set,this.watchers.set(e,i),s&&this.connection.send({type:"watch",data:{varId:e}})),i.add(t),()=>{i.delete(t),i.size===0&&(this.watchers.delete(e),this.connection.send({type:"unwatch",data:{varId:e}}))}}watchErrors(e,t){let s=this.errorWatchers.get(e);s||(s=new Set,this.errorWatchers.set(e,s)),s.add(t);const i=this.errors.get(e)??null;return t(i),()=>{s.delete(t),s.size===0&&this.errorWatchers.delete(e)}}getError(e){return this.errors.get(e)??null}get(e){return this.variables.get(e)}async create(e){var s;console.log("SENDING CREATE");const t=await this.connection.sendAndAwaitResponse({type:"create",data:e});if(t.error)throw new Error(t.error);if(!t.result)throw new Error("No result from create");if((s=t.pending)!=null&&s.length){const i=t.pending[0].data;console.log("CREATE RESPONSE",t.result.id,t);const n={varId:i.varId,value:void 0,properties:e.properties||{}};e.parentId!==void 0&&(n.parentId=e.parentId),this.variables.set(i.varId,n),setTimeout(()=>{console.log("UPDATE FROM CREATE RESPONSE",i.varId,t),this.handleUpdate(i.varId,i.value,i.properties,e.parentId)})}return t.result.id}update(e,t,s){this.connection.send({type:"update",data:{varId:e,value:t,properties:s}})}destroy(e){this.connection.send({type:"destroy",data:{varId:e}})}sendError(e,t,s){this.connection.send({type:"error",data:{varId:e,code:t,description:s}}),this.handleError(e,t,s)}}let q=1;function $(){return`ui-${q++}`}function w(a){return a.id||(a.id=$()),a.id}function j(a){return a instanceof HTMLElement&&(a.nodeName=="SL-INPUT"||a.nodeName=="SL-TEXTAREA")}function b(a){const[e,t]=a.split("?"),s=e.split("."),i={};if(t){const n=new URLSearchParams(t),r=l=>{const h=n.get(l);return h===""?"true":h};n.has("create")&&(i.create=r("create")),n.has("wrapper")&&(i.wrapper=r("wrapper")),n.has("item")&&(i.item=r("item"));const o={};n.forEach((l,h)=>{h!=="create"&&h!=="wrapper"&&h!=="item"&&(o[h]=l===""?"true":l)}),Object.keys(o).length>0&&(i.props=o)}return{segments:s,options:i}}function y(a){const e={};return a.create&&(e.create=a.create),a.wrapper&&(e.wrapper=a.wrapper),a.item&&(e.item=a.item),a.props&&Object.assign(e,a.props),e}class D{constructor(e){c(this,"store");c(this,"bindings",new Map);this.store=e}bindElement(e,t){const s=[],i=e.getAttribute("ui-value");if(i){const o=this.createValueBinding(e,t,i);o&&s.push(o)}for(const o of Array.from(e.attributes))if(o.name.startsWith("ui-attr-")){const l=o.name.substring(8),h=this.createAttrBinding(e,t,o.value,l);h&&s.push(h)}for(const o of Array.from(e.attributes))if(o.name.startsWith("ui-class-")){const l=o.name.substring(9),h=this.createClassBinding(e,t,o.value,l);h&&s.push(h)}for(const o of Array.from(e.attributes))if(o.name.startsWith("ui-style-")){const l=o.name.substring(9),h=this.createStyleBinding(e,t,o.value,l);h&&s.push(h)}for(const o of Array.from(e.attributes))if(o.name.startsWith("ui-event-")){const l=o.name.substring(9),h=this.createEventBinding(e,t,o.value,l);h&&s.push(h)}const n=e.getAttribute("ui-action");if(n){const o=this.createActionBinding(e,t,n);o&&s.push(o)}const r=e.getAttribute("ui-code");if(r){const o=this.createCodeBinding(e,t,r);o&&s.push(o)}if(s.length>0){const o=w(e);this.bindings.set(o,s)}for(const o of Array.from(e.children))this.bindElement(o,t)}unbindElement(e){const t=e.id;if(t){const s=this.bindings.get(t);s&&(s.forEach(i=>i.unbind()),this.bindings.delete(t))}for(const s of Array.from(e.children))this.unbindElement(s)}createValueBinding(e,t,s){var P,H;const i=b(s),n=y(i.options);n.path=i.segments.join(".");const r=((P=i.options.props)==null?void 0:P.keypress)==="true";let o=null,l=null,h=null;const u=e.tagName.includes("-"),p=!(e instanceof HTMLButtonElement)&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement||j(e)||u||"value"in e),f=p?g=>{typeof g=="number"?e.value=g:e.value=(g==null?void 0:g.toString())??""}:g=>e.textContent=(g==null?void 0:g.toString())??"",m=g=>{g?(e.classList.add("ui-error"),e.setAttribute("ui-error-code",g.code),e.setAttribute("ui-error-description",g.description)):(e.classList.remove("ui-error"),e.removeAttribute("ui-error-code"),e.removeAttribute("ui-error-description"))},S=g=>{if(o!==null){const v=g.target;this.store.update(o,v.value)}};if((H=i.segments[i.segments.length-1])==null?void 0:H.endsWith("()")){if(n.access===void 0)n.access="r";else if(n.access!=="r"&&n.access!=="action")return console.error(`Invalid access '${n.access}' for method call path '${s}' - must be 'r' or 'action'`),null}else!p&&n.access===void 0&&(n.access="r");this.store.create({parentId:t,properties:n}).then(g=>{o=g,l=this.store.watch(g,(le,k)=>f(k)),h=this.store.watchErrors(g,m);const v=this.store.get(g);v&&f(v.value)}).catch(g=>{console.error("Failed to create binding variable:",g)});const R=e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement,V=e.tagName.toLowerCase(),B=V==="sl-input"||V==="sl-textarea";let E=null,I=null;R&&(E=r?"input":"blur"),B&&(I=r?"sl-input":"sl-change"),E&&e.addEventListener(E,S);const N=g=>{if(o!==null){const v=g.target;this.store.update(o,v.value)}};I&&e.addEventListener(I,N);const T=g=>{const v=g;o!==null&&this.store.update(o,v.detail.value)};return e.addEventListener("ui-value-change",T),{elementId:w(e),unbind:()=>{l&&l(),h&&h(),E&&e.removeEventListener(E,S),I&&e.removeEventListener(I,N),e.removeEventListener("ui-value-change",T),o!==null&&this.store.destroy(o),e.classList.remove("ui-error"),e.removeAttribute("ui-error-code"),e.removeAttribute("ui-error-description")}}}createAttrBinding(e,t,s,i){const n=b(s),r=y(n.options);r.path=n.segments.join("."),r.access||(r.access="r");let o=null,l=null;const h=d=>{d!=null&&d!==!1?e.setAttribute(i,d.toString()):e.removeAttribute(i)};return this.store.create({parentId:t,properties:r}).then(d=>{o=d,l=this.store.watch(d,(f,m)=>h(m));const p=this.store.get(d);p&&h(p.value)}).catch(d=>{console.error("Failed to create attr binding variable:",d)}),{elementId:w(e),unbind:()=>{l&&l(),o!==null&&this.store.destroy(o)}}}createClassBinding(e,t,s,i){const n=b(s),r=y(n.options);r.path=n.segments.join("."),r.access||(r.access="r");let o=null,l=null;const h=d=>{d?e.classList.add(i):e.classList.remove(i)};return this.store.create({parentId:t,properties:r}).then(d=>{o=d,l=this.store.watch(d,(f,m)=>h(m));const p=this.store.get(d);p&&h(p.value)}).catch(d=>{console.error("Failed to create class binding variable:",d)}),{elementId:w(e),unbind:()=>{l&&l(),o!==null&&this.store.destroy(o)}}}createStyleBinding(e,t,s,i){const n=b(s),r=y(n.options);r.path=n.segments.join(".");const o=e;r.access||(r.access="r");let l=null,h=null;const u=p=>{p!=null?o.style.setProperty(i,p.toString()):o.style.removeProperty(i)};return this.store.create({parentId:t,properties:r}).then(p=>{l=p,h=this.store.watch(p,(m,S)=>u(S));const f=this.store.get(p);f&&u(f.value)}).catch(p=>{console.error("Failed to create style binding variable:",p)}),{elementId:w(e),unbind:()=>{h&&h(),l!==null&&this.store.destroy(l)}}}createCodeBinding(e,t,s){const i=b(s),n=y(i.options);n.path=i.segments.join("."),n.access||(n.access="r");let r=null,o=null;const l=u=>{if(!(typeof u!="string"||!u))try{const d=new Function("element","value","variable","store",u),p=r!==null?this.store.get(r):null;d(e,p==null?void 0:p.value,p,this.store)}catch(d){console.error("Error executing ui-code:",d)}};return this.store.create({parentId:t,properties:n}).then(u=>{r=u,o=this.store.watch(u,(p,f)=>l(f));const d=this.store.get(u);d!=null&&d.value&&l(d.value)}).catch(u=>{console.error("Failed to create code binding variable:",u)}),{elementId:w(e),unbind:()=>{o&&o(),r!==null&&this.store.destroy(r)}}}createEventBinding(e,t,s,i){const n=s.match(/^([\w.]+)\((.*)\)$/);if(!n)return console.error("Invalid action expression:",s),null;const[,r,o]=n,u={path:o==="_"?`${r}(_)`:`${r}()`,access:"action"};let d=null;this.store.create({parentId:t,properties:u}).then(m=>{d=m}).catch(m=>{console.error("Failed to create action variable:",m)});const p=m=>{d!==null&&this.store.update(d,null)};return e.addEventListener(i,p),{elementId:w(e),unbind:()=>{e.removeEventListener(i,p),d!==null&&this.store.destroy(d)}}}createActionBinding(e,t,s){const i=s.match(/^([\w.]+)\((.*)\)$/);if(!i)return console.error("Invalid action expression:",s),null;const[,n,r]=i,h={path:r==="_"?`${n}(_)`:`${n}()`,access:"action"};let u=null;this.store.create({parentId:t,properties:h}).then(f=>{u=f}).catch(f=>{console.error("Failed to create action variable:",f)});const d=f=>{f.preventDefault(),u!==null&&this.store.update(u,null)};return e.addEventListener("click",d),{elementId:w(e),unbind:()=>{e.removeEventListener("click",d),u!==null&&this.store.destroy(u)}}}}function J(a){const e=a.indexOf(".");return e===-1?null:{type:a.substring(0,e),namespace:a.substring(e+1)}}function C(a,e){return`${a}.${e}`}function z(a){const e=document.createElement("div");if(e.innerHTML=a.trim(),e.children.length!==1)return null;const t=e.children[0];return t instanceof HTMLTemplateElement?t:null}function K(a,e){const t=J(a);if(!t)return null;const s=z(e);return s?{type:t.type,namespace:t.namespace,template:s}:null}function G(a){return a.template.content.cloneNode(!0)}function X(a){return Array.from(a.querySelectorAll("script"))}function Y(a){for(const e of a){const t=document.createElement("script");t.type="text/javascript",t.textContent=e.textContent,e.replaceWith(t)}}class Q{constructor(){c(this,"viewdefs",new Map);c(this,"pendingViews",new Map);c(this,"errorHandler")}setErrorHandler(e){this.errorHandler=e}store(e,t){const s=K(e,t);return s?(this.viewdefs.set(e,s),!0):(this.errorHandler&&this.errorHandler(e,"Invalid viewdef: must be a single <template> element"),!1)}processViewdefs(e){for(const[t,s]of Object.entries(e))this.store(t,s);this.processPendingViews()}get(e,t,s){if(t){const n=C(e,t),r=this.viewdefs.get(n);if(r)return r}if(s){const n=C(e,s),r=this.viewdefs.get(n);if(r)return r}const i=C(e,"DEFAULT");return this.viewdefs.get(i)}getByKey(e){return this.viewdefs.get(e)}has(e,t){return this.get(e,t)!==void 0}addPendingView(e){this.pendingViews.set(e.id,e)}removePendingView(e){this.pendingViews.delete(e)}processPendingViews(){const e=[];for(const[t,s]of this.pendingViews)s.render()&&e.push(t);for(const t of e)this.pendingViews.delete(t)}getPendingViewCount(){return this.pendingViews.size}getViewdefCount(){return this.viewdefs.size}getKeys(){return Array.from(this.viewdefs.keys())}clear(){this.viewdefs.clear()}}function Z(a){const[e,t]=a.split("?"),s={path:e,props:{}};return t&&new URLSearchParams(t).forEach((n,r)=>{r==="item"?s.item=n:s.props[r]=n}),s}class ee{constructor(e,t,s,i){c(this,"elementId");c(this,"itemWrapper");c(this,"variableId",null);c(this,"viewIds",[]);c(this,"exemplarHtml");c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"bindCallback");c(this,"pathConfig",null);this.elementId=w(e),this.itemWrapper=e.getAttribute("ui-item-wrapper")||void 0,this.viewdefStore=t,this.variableStore=s,this.bindCallback=i;const n=e.firstElementChild;n instanceof HTMLElement?(this.exemplarHtml=n.outerHTML,e.removeChild(n)):this.exemplarHtml="<div></div>"}getElement(){return document.getElementById(this.elementId)}getItemWrapper(){}setExemplar(e){this.exemplarHtml=e.outerHTML}setPathConfig(e){this.pathConfig=Z(e)}getVariableProperties(){const e={};return this.pathConfig&&(this.pathConfig.item&&(e.item=this.pathConfig.item),Object.assign(e,this.pathConfig.props)),e}getBasePath(){var e;return((e=this.pathConfig)==null?void 0:e.path)||""}resolveNamespace(e,t){const s=e.closest("[ui-namespace]");if(!s)return t==null?void 0:t.properties.namespace;const i=this.getElement();return i&&i.contains(s)?s.getAttribute("ui-namespace")||void 0:t==null?void 0:t.properties.namespace}setVariable(e){this.unwatch&&(this.unwatch(),this.unwatch=null),this.variableId=e,this.unwatch=this.variableStore.watch(e,()=>{this.update()}),this.update()}update(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);if(!e)return;const t=e.value;if(!Array.isArray(t)){this.clear();return}const s=t.length,i=this.viewIds.slice();for(;i.length<s;){const n=this.createItemView(),r=i.length;i.push(n.elementId);const o=this.itemWrapper?`${r}?wrapper=${this.itemWrapper}`:String(r),l=this.variableStore.get(this.variableId),h=l!=null&&l.parentId?this.variableStore.get(l.parentId):void 0;console.log("CREATE LIST ITEM VIEW WITH PARENT",JSON.stringify(h));const u={path:o,elementId:n.elementId},d=h==null?void 0:h.properties.itemWrapper;d&&(u.wrapper=d);const p=n.getElement();if(p){const f=this.resolveNamespace(p,l);f&&(u.namespace=f)}l!=null&&l.properties.fallbackNamespace&&(u.fallbackNamespace=l.properties.fallbackNamespace),this.variableStore.create({parentId:this.variableId,properties:u}).then(f=>{console.log("setting view ",r," variable ",f),n.setVariable(f)}).catch(f=>{console.error("Failed to create viewlist item variable:",f)})}for(;i.length>s;){const n=i.pop(),r=document.getElementById(n);r&&r.parentNode&&r.parentNode.removeChild(r)}this.viewIds=i}createItemView(){const e=document.createElement("template");e.innerHTML=this.exemplarHtml;const t=e.content.firstElementChild,s=this.getElement();return s&&s.appendChild(t),new A(t,this.viewdefStore,this.variableStore,this.bindCallback)}clear(){for(const t of this.viewIds){const s=document.getElementById(t);s&&s.parentNode&&s.parentNode.removeChild(s)}this.viewIds=[];const e=this.getElement();if(e)for(;e.firstChild;)e.removeChild(e.firstChild)}getCount(){return this.viewIds.length}getViewElement(e){const t=this.viewIds[e];return t?document.getElementById(t):null}getViewIds(){return[...this.viewIds]}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.clear()}}function te(a,e,t,s){const i=new ee(a,e,t,s),n=a.getAttribute("ui-viewlist");return n&&i.setPathConfig(n),i}class A{constructor(e,t,s,i){c(this,"elementId");c(this,"valueType","");c(this,"variableId",null);c(this,"rendered",!1);c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"bindCallback");c(this,"viewLists",[]);c(this,"childViews",[]);this.elementId=w(e),this.viewdefStore=t,this.variableStore=s,this.bindCallback=i,e.getAttribute("ui-view")}getElement(){return document.getElementById(this.elementId)}getNamespace(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);return e==null?void 0:e.properties.namespace}getFallbackNamespace(){if(this.variableId===null)return;const e=this.variableStore.get(this.variableId);return e==null?void 0:e.properties.fallbackNamespace}resolveNamespace(e,t){const s=e.closest("[ui-namespace]");if(!s){const o=this.variableStore.get(t);return o==null?void 0:o.properties.namespace}const i=this.variableStore.get(t),n=i==null?void 0:i.properties.elementId,r=n?document.getElementById(n):null;return!r||r.contains(s)?s.getAttribute("ui-namespace")||void 0:i==null?void 0:i.properties.namespace}setVariable(e,t){this.unwatch&&(this.unwatch(),this.unwatch=null),this.variableId=e,this.rendered=!1,console.log("SET VIEW VARIABLE",this,this.variableStore.get(this.variableId)),this.unwatch=this.variableStore.watch(e,(s,i,n)=>{this.render()},t),this.render()}setVariableFromRef(e){console.error("THIS IS ERRONEOUS CODE")}render(){if(console.log("1"),this.variableId===null)return!1;const e=this.variableStore.get(this.variableId);if(!e)return this.markPending(),!1;console.log("2");const t=e.properties.type;if(!t)return this.markPending(),!1;const s=this.getNamespace(),i=this.getFallbackNamespace(),n=this.viewdefStore.get(t,s,i);if(!n)return this.markPending(),!1;if(console.log("3"),this.rendered&&t===this.valueType)return!1;this.clear(),console.log("RENDER VIEW",this);const r=G(n),o=X(r),l=this.getElement();if(!l)return console.error("View element not found:",this.elementId),!1;if(l.appendChild(r),this.processViewLists(l,this.variableId),this.processChildViews(l,this.variableId),this.bindCallback)for(const h of l.children)h instanceof HTMLElement&&this.bindCallback(h,this.variableId);return Y(o),this.rendered=!0,this.valueType=t,this.removePending(),!0}processViewLists(e,t){const s=e.querySelectorAll("[ui-viewlist]");for(const i of s)i instanceof HTMLElement&&this.setupViewList(i,t)}setupViewList(e,t){const s=te(e,this.viewdefStore,this.variableStore,this.bindCallback);if(e.getAttribute("ui-viewlist")){const n=s.getBasePath(),r=s.getVariableProperties(),o=w(e),l={path:n,elementId:o,...r},h=this.resolveNamespace(e,t);h&&(l.namespace=h);const u=this.variableStore.get(t);u!=null&&u.properties.fallbackNamespace&&(l.fallbackNamespace=u.properties.fallbackNamespace),l.access||(l.access="r"),this.variableStore.create({parentId:t,properties:l}).then(d=>{s.setVariable(d)}).catch(d=>{console.error("Failed to create viewlist variable:",d)})}this.viewLists.push(s)}processChildViews(e,t){const s=e.querySelectorAll("[ui-view]");for(const i of s)i instanceof HTMLElement&&this.setupChildView(i,t)}setupChildView(e,t){const s=new A(e,this.viewdefStore,this.variableStore,this.bindCallback),i=e.getAttribute("ui-view");if(i){const[n]=i.split("?"),r=b(i);console.log("CREATING VIEW FOR ",i," parent: ",t);let o=r.options.props;o?delete r.options.props:o={};const l=w(e),h={path:n,elementId:l,...r.options,...o},u=this.resolveNamespace(e,t);u&&(h.namespace=u);const d=this.variableStore.get(t);d!=null&&d.properties.fallbackNamespace&&(h.fallbackNamespace=d.properties.fallbackNamespace),h.access||(h.access="r"),this.variableStore.create({parentId:t,properties:h}).then(p=>{var f;console.log("GET VIEW VARIABLE ",p," props: ",JSON.stringify((f=this.variableStore.get(p))==null?void 0:f.properties)),s.setVariable(p)}).catch(p=>{console.error("Failed to create view variable:",p)})}this.childViews.push(s)}clear(){for(const t of this.viewLists)t.destroy();this.viewLists=[];for(const t of this.childViews)t.destroy();this.childViews=[];const e=this.getElement();if(e)for(;e.firstChild;)e.removeChild(e.firstChild);this.rendered=!1}markPending(){this.viewdefStore.addPendingView({id:this.elementId,render:()=>this.render()})}removePending(){this.viewdefStore.removePendingView(this.elementId)}isRendered(){return this.rendered}getVariableId(){return this.variableId}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.removePending(),this.clear()}}const se=1;class ie{constructor(e,t,s,i){c(this,"elementId");c(this,"variableId",se);c(this,"namespace");c(this,"view",null);c(this,"viewdefStore");c(this,"variableStore");c(this,"unwatch",null);c(this,"bindCallback");this.elementId=w(e),this.namespace=e.getAttribute("ui-namespace")||"DEFAULT",this.viewdefStore=t,this.variableStore=s,this.bindCallback=i}getElement(){return document.getElementById(this.elementId)}initialize(){const e=this.getElement();if(!e){console.error("AppView element not found:",this.elementId);return}this.view=new A(e,this.viewdefStore,this.variableStore,this.bindCallback),this.view.setVariable(this.variableId,!0),this.unwatch=this.variableStore.watch(this.variableId,(t,s,i)=>{this.handleRootUpdate(s,i??{})},!1)}handleRootUpdate(e,t){console.log("handleRootUpdate called, props:",Object.keys(t));const s=t.viewdefs;if(s){console.log("Found viewdefs property, length:",s.length);try{const i=JSON.parse(s);typeof i=="object"&&i!==null&&(console.log("Parsed viewdefs, keys:",Object.keys(i)),this.viewdefStore.processViewdefs(i))}catch(i){console.error("Failed to parse viewdefs property:",i)}}else console.log("No viewdefs property found")}getView(){return this.view}isRendered(){var e;return((e=this.view)==null?void 0:e.isRendered())??!1}destroy(){this.unwatch&&(this.unwatch(),this.unwatch=null),this.view&&(this.view.destroy(),this.view=null)}}function L(){return document.querySelector("[ui-app]")}function ne(a,e,t){const s=L();if(!s)return null;const i=new ie(s,a,e,t);return i.initialize(),i}class re{constructor(){c(this,"connection");c(this,"store");c(this,"viewdefStore");c(this,"binding");c(this,"sessionId");c(this,"appView",null);this.sessionId=this.extractSessionId(),this.connection=new _(this.sessionId),this.store=new U(this.connection),this.viewdefStore=new Q,this.binding=new D(this.store)}extractSessionId(){const t=window.location.pathname.split("/").filter(Boolean);if(t.length>0)return t[0];throw new Error("No session ID in URL")}async initialize(){this.connection.onConnect(()=>{console.log("Connected to session:",this.sessionId)}),this.connection.onDisconnect(()=>{console.log("Disconnected from session")}),this.connection.onError(t=>{console.error("Connection error:",t)}),this.connection.onMessage(t=>{this.handleMessage(t)}),await this.connection.connect(),L()&&(this.appView=ne(this.viewdefStore,this.store,(t,s)=>this.binding.bindElement(t,s)))}handleMessage(e){switch(e.type){case"error":const t=e.data;console.error("Server error:",t.description);break}}navigateTo(e){window.history.pushState({},"",e),this.handleNavigation()}handleNavigation(){const s="/"+window.location.pathname.split("/").filter(Boolean).slice(1).join("/");this.store.update(1,void 0,{url:s})}getStore(){return this.store}getViewdefStore(){return this.viewdefStore}getConnection(){return this.connection}getAppView(){return this.appView}}function oe(){const a=new re;return a.initialize().then(()=>a)}document.addEventListener("DOMContentLoaded",()=>{L()&&oe().then(e=>{window.uiApp=e,window.uiStore=e.getStore()}).catch(console.error)});
